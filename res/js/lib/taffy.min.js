var TAFFY,exports,T;(function(){"use strict";var s,y,e,h,b,c,l,p,t,w,n,u,a,o,r,f,v,i;if(!TAFFY)for(b="2.6.2",c=1,l="000000",p=1e3,t={},w=function(n){return TAFFY.isArray(n)||TAFFY.isObject(n)?n:JSON.parse(n)},n=function(n,t,i){var f,u,r,e;if(n&&(T.isArray(n)&&n.length===1||!T.isArray(n)))t(T.isArray(n)?n[0]:n,0);else for(f,u,r=0,n=T.isArray(n)?n:[n],e=n.length;r<e;r++)if(u=n[r],(!T.isUndefined(u)||i||!1)&&(f=t(u,r),f===T.EXIT))break},u=function(n,t){var u=0,r,i;for(i in n)if(n.hasOwnProperty(i)&&(r=t(n[i],i,u++),r===T.EXIT))break},t.extend=function(n,i){t[n]=function(){return i.apply(this,arguments)}},a=function(t){var i;return T.isString(t)&&/[t][0-9]*[r][0-9]*/i.test(t)?!0:T.isObject(t)&&t.___id&&t.___s?!0:T.isArray(t)?(i=!0,n(t,function(n){if(!a(n))return i=!1,TAFFY.EXIT}),i):!1},r=function(t,i){var u=!0;return n(i,function(i){switch(T.typeOf(i)){case"function":if(!i.apply(t))return u=!1,TAFFY.EXIT;break;case"array":u=i.length===1?r(t,i[0]):i.length===2?r(t,i[0])||r(t,i[1]):i.length===3?r(t,i[0])||r(t,i[1])||r(t,i[2]):i.length===4?r(t,i[0])||r(t,i[1])||r(t,i[2])||r(t,i[3]):!1,i.length>4&&n(i,function(n){r(t,n)&&(u=!0)})}}),u},o=function(t){var i=[];return(T.isString(t)&&/[t][0-9]*[r][0-9]*/i.test(t)&&(t={___id:t}),T.isArray(t))?(n(t,function(n){i.push(o(n))}),t=function(){var u=this,t=!1;return n(i,function(n){r(u,n)&&(t=!0)}),t}):T.isObject(t)?(T.isObject(t)&&t.___id&&t.___s&&(t={___id:t.___id}),u(t,function(t,r){T.isObject(t)||(t={is:t}),u(t,function(t,u){var f=[],e;e=u==="hasAll"?function(n,t){t(n)}:n,e(t,function(n){var t=!0,e=!1,i;i=function(){var i=this[r],s="==",e="!=",h="===",c="<",l=">",a="<=",v=">=",o="!==",f;return u.indexOf("!")===0&&u!==e&&u!==o&&(t=!1,u=u.substring(1,u.length)),f=u==="regex"?n.test(i):u==="lt"||u===c?i<n:u==="gt"||u===l?i>n:u==="lte"||u===a?i<=n:u==="gte"||u===v?i>=n:u==="left"?i.indexOf(n)===0:u==="leftnocase"?i.toLowerCase().indexOf(n.toLowerCase())===0:u==="right"?i.substring(i.length-n.length)===n:u==="rightnocase"?i.toLowerCase().substring(i.length-n.length)===n.toLowerCase():u==="like"?i.indexOf(n)>=0:u==="likenocase"?i.toLowerCase().indexOf(n.toLowerCase())>=0:u===h||u==="is"?i===n:u===s?i==n:u===o?i!==n:u===e?i!=n:u==="isnocase"?i.toLowerCase?i.toLowerCase()===n.toLowerCase():i===n:u==="has"?T.has(i,n):u==="hasall"?T.hasAll(i,n):u.indexOf("is")===-1&&!TAFFY.isNull(i)&&!TAFFY.isUndefined(i)&&!TAFFY.isObject(n)&&!TAFFY.isArray(n)?n===i[u]:T[u]&&T.isFunction(T[u])&&u.indexOf("is")===0?T[u](i)===n:T[u]&&T.isFunction(T[u])?T[u](i,n):!1,f=f&&!t?!1:!f&&!t?!0:f},f.push(i)}),f.length===1?i.push(f[0]):i.push(function(){var i=this,t=!1;return n(f,function(n){n.apply(i)&&(t=!0)}),t})})}),t=function(){var t=this,u=!0;return u=i.length===1&&!i[0].apply(t)?!1:i.length===2&&(!i[0].apply(t)||!i[1].apply(t))?!1:i.length===3&&(!i[0].apply(t)||!i[1].apply(t)||!i[2].apply(t))?!1:i.length===4&&(!i[0].apply(t)||!i[1].apply(t)||!i[2].apply(t)||!i[3].apply(t))?!1:!0,i.length>4&&n(i,function(n){r(t,n)||(u=!1)}),u}):T.isFunction(t)?t:void 0},v=function(n,t){var i=function(n,i){var r=0;return T.each(t,function(t){var h,o,s,u,e;if(h=t.split(" "),o=h[0],s=h.length===1?"logical":h[1],s==="logical")u=f(n[o]),e=f(i[o]),T.each(u.length<=e.length?u:e,function(n,t){return u[t]<e[t]?(r=-1,TAFFY.EXIT):u[t]>e[t]?(r=1,TAFFY.EXIT):void 0});else if(s==="logicaldesc")u=f(n[o]),e=f(i[o]),T.each(u.length<=e.length?u:e,function(n,t){return u[t]>e[t]?(r=-1,TAFFY.EXIT):u[t]<e[t]?(r=1,TAFFY.EXIT):void 0});else{if(s==="asec"&&n[o]<i[o])return r=-1,T.EXIT;if(s==="asec"&&n[o]>i[o])return r=1,T.EXIT;if(s==="desc"&&n[o]>i[o])return r=-1,T.EXIT;if(s==="desc"&&n[o]<i[o])return r=1,T.EXIT}return r===0&&s==="logical"&&u.length<e.length?r=-1:r===0&&s==="logical"&&u.length>e.length?r=1:r===0&&s==="logicaldesc"&&u.length>e.length?r=-1:r===0&&s==="logicaldesc"&&u.length<e.length&&(r=1),r!==0?T.EXIT:void 0}),r};return n&&n.push?n.sort(i):n},function(){var n={},t=0;f=function(i){return t>p&&(n={},t=0),n["_"+i]||function(){for(var o=String(i),u=[],r="_",e="",s,f=0,h=o.length;f<h;f++)s=o.charCodeAt(f),s>=48&&s<=57||s===46?(e!=="n"&&(e="n",u.push(r.toLowerCase()),r=""),r=r+o.charAt(f)):(e!=="s"&&(e="s",u.push(parseFloat(r)),r=""),r=r+o.charAt(f));return u.push(e==="n"?parseFloat(r):r.toLowerCase()),u.shift(),n["_"+i]=u,t++,u}()}}(),i=function(){this.context({results:this.getDBI().query(this.context())})},t.extend("filter",function(){var t=TAFFY.mergeObj(this.context(),{run:null}),i=[];return n(t.q,function(n){i.push(n)}),t.q=i,n(arguments,function(n){t.q.push(o(n)),t.filterRaw.push(n)}),this.getroot(t)}),t.extend("order",function(t){t=t.split(",");var r=[],i;return n(t,function(n){r.push(n.replace(/^\s*/,"").replace(/\s*$/,""))}),i=TAFFY.mergeObj(this.context(),{sort:null}),i.order=r,this.getroot(i)}),t.extend("limit",function(t){var i=TAFFY.mergeObj(this.context(),{}),r;return i.limit=t,i.run&&i.sort&&(r=[],n(i.results,function(n,i){if(i+1>t)return TAFFY.EXIT;r.push(n)}),i.results=r),this.getroot(i)}),t.extend("start",function(t){var i=TAFFY.mergeObj(this.context(),{}),r;return i.start=t,i.run&&i.sort&&!i.limit?(r=[],n(i.results,function(n,i){i+1>t&&r.push(n)}),i.results=r):i=TAFFY.mergeObj(this.context(),{run:null,start:t}),this.getroot(i)}),t.extend("update",function(t,r,u){var f=!0,e={},s=arguments,o;return TAFFY.isString(t)&&(arguments.length===2||arguments.length===3)?(e[t]=r,arguments.length===3&&(f=u)):(e=t,s.length===2&&(f=r)),o=this,i.call(this),n(this.context().results,function(n){var t=e;TAFFY.isFunction(t)?t=t.apply(TAFFY.mergeObj(n,{})):T.isFunction(t)&&(t=t(TAFFY.mergeObj(n,{}))),TAFFY.isObject(t)&&o.getDBI().update(n.___id,t,f)}),this.context().results.length&&this.context({run:null}),this}),t.extend("remove",function(t){var r=this,u=0;return i.call(this),n(this.context().results,function(n){r.getDBI().remove(n.___id),u++}),this.context().results.length&&(this.context({run:null}),r.getDBI().removeCommit(t)),u}),t.extend("count",function(){return i.call(this),this.context().results.length}),t.extend("callback",function(n,t){if(n){var r=this;setTimeout(function(){i.call(r),n.call(r.getroot(r.context()))},t||0)}return null}),t.extend("get",function(){return i.call(this),this.context().results}),t.extend("stringify",function(){return JSON.stringify(this.get())}),t.extend("first",function(){return i.call(this),this.context().results[0]||!1}),t.extend("last",function(){return i.call(this),this.context().results[this.context().results.length-1]||!1}),t.extend("sum",function(){var t=0,r=this;return i.call(r),n(arguments,function(i){n(r.context().results,function(n){t=t+n[i]})}),t}),t.extend("min",function(t){var r=null;return i.call(this),n(this.context().results,function(n){(r===null||n[t]<r)&&(r=n[t])}),r}),function(){var n=function(){var n,t,i;return n=function(n,t,i){var r,u,f,e;i.length===2?(r=n[i[0]],f="===",u=t[i[1]]):(r=n[i[0]],f=i[1],u=t[i[2]]);switch(f){case"===":return r===u;case"!==":return r!==u;case"<":return r<u;case">":return r>u;case"<=":return r<=u;case">=":return r>=u;case"==":return r==u;case"!=":return r!=u;default:throw String(f)+" is not supported";}},t=function(n,t){var r={},i,u;for(i in n)n.hasOwnProperty(i)&&(r[i]=n[i]);for(i in t)t.hasOwnProperty(i)&&i!=="___id"&&i!=="___s"&&(u=TAFFY.isUndefined(r[i])?"":"right_",r[u+String(i)]=t[i]);return r},i=function(i){var u,r,f=arguments,o=f.length,e=[];if(typeof i.filter!="function")if(i.TAFFY)u=i();else throw"TAFFY DB or result not supplied";else u=i;return this.context({results:this.getDBI().query(this.context())}),TAFFY.each(this.context().results,function(i){u.each(function(u){var s,h=!0;n:for(r=1;r<o;r++)if(s=f[r],h=typeof s=="function"?s(i,u):typeof s=="object"&&s.length?n(i,u,s):!1,!h)break n;h&&e.push(t(i,u))})}),TAFFY(e)()}}();t.extend("join",n)}(),t.extend("max",function(t){var r=null;return i.call(this),n(this.context().results,function(n){(r===null||n[t]>r)&&(r=n[t])}),r}),t.extend("select",function(){var t=[],r=arguments;return i.call(this),arguments.length===1?n(this.context().results,function(n){t.push(n[r[0]])}):n(this.context().results,function(i){var u=[];n(r,function(n){u.push(i[n])}),t.push(u)}),t}),t.extend("distinct",function(){var t=[],r=arguments;return i.call(this),arguments.length===1?n(this.context().results,function(i){var u=i[r[0]],f=!1;n(t,function(n){if(u===n)return f=!0,TAFFY.EXIT}),f||t.push(u)}):n(this.context().results,function(i){var u=[],f=!1;n(r,function(n){u.push(i[n])}),n(t,function(t){var i=!0;return n(r,function(n,r){if(u[r]!==t[r])return i=!1,TAFFY.EXIT}),i?(f=!0,TAFFY.EXIT):void 0}),f||t.push(u)}),t}),t.extend("supplant",function(t,r){var u=[];return i.call(this),n(this.context().results,function(n){u.push(t.replace(/\{([^\{\}]*)\}/g,function(t,i){var r=n[i];return typeof r=="string"||typeof r=="number"?r:t}))}),r?u:u.join("")}),t.extend("each",function(t){return i.call(this),n(this.context().results,t),this}),t.extend("map",function(t){var r=[];return i.call(this),n(this.context().results,function(n){r.push(t(n))}),r}),T=function(i){var e=[],h={},g=1,f={template:!1,onInsert:!1,onUpdate:!1,onRemove:!1,onDBChange:!1,storageName:!1,forcePropertyCase:null,cacheSize:100,name:""},nt=new Date,b=0,k=0,p={},y,d,s;return d=function(t){var i=[],r=!1;return t.length===0?e:(n(t,function(t){T.isString(t)&&/[t][0-9]*[r][0-9]*/i.test(t)&&e[h[t]]&&(i.push(e[h[t]]),r=!0),T.isObject(t)&&t.___id&&t.___s&&e[h[t.___id]]&&(i.push(e[h[t.___id]]),r=!0),T.isArray(t)&&n(t,function(t){n(d(t),function(n){i.push(n)})})}),r&&i.length>1&&(i=[]),i)},y={dm:function(n){return n&&(nt=n,p={},b=0,k=0),f.onDBChange&&setTimeout(function(){f.onDBChange.call(e)},0),f.storageName&&setTimeout(function(){localStorage.setItem("taffy_"+f.storageName,JSON.stringify(e))}),nt},insert:function(t,i){var r=[],o=[],a=w(t);return n(a,function(t,s){var a,v;if(T.isArray(t)&&s===0)return n(t,function(n){r.push(f.forcePropertyCase==="lower"?n.toLowerCase():f.forcePropertyCase==="upper"?n.toUpperCase():n)}),!0;T.isArray(t)?(a={},n(t,function(n,t){a[r[t]]=n}),t=a):T.isObject(t)&&f.forcePropertyCase&&(v={},u(t,function(n,i){v[f.forcePropertyCase==="lower"?i.toLowerCase():f.forcePropertyCase==="upper"?i.toUpperCase():i]=t[i]}),t=v),g++,t.___id="T"+String(l+c).slice(-6)+"R"+String(l+g).slice(-6),t.___s=!0,o.push(t.___id),f.template&&(t=T.mergeObj(f.template,t)),e.push(t),h[t.___id]=e.length-1,f.onInsert&&(i||TAFFY.isUndefined(i))&&f.onInsert.call(t),y.dm(new Date)}),s(o)},sort:function(t){return e=v(e,t.split(",")),h={},n(e,function(n,t){h[n.___id]=t}),y.dm(new Date),!0},update:function(n,t,i){var l={},r,o,s,c;f.forcePropertyCase&&(u(t,function(n,t){l[f.forcePropertyCase==="lower"?t.toLowerCase():f.forcePropertyCase==="upper"?t.toUpperCase():t]=n}),t=l),r=e[h[n]],o=T.mergeObj(r,t),s={},c=!1,u(o,function(n,t){(TAFFY.isUndefined(r[t])||r[t]!==n)&&(s[t]=n,c=!0)}),c&&(f.onUpdate&&(i||TAFFY.isUndefined(i))&&f.onUpdate.call(o,e[h[n]],s),e[h[n]]=o,y.dm(new Date))},remove:function(n){e[h[n]].___s=!1},removeCommit:function(t){for(var i=e.length-1;i>-1;i--)e[i].___s||(f.onRemove&&(t||TAFFY.isUndefined(t))&&f.onRemove.call(e[i]),h[e[i].___id]=undefined,e.splice(i,1));h={},n(e,function(n,t){h[n.___id]=t}),y.dm(new Date)},query:function(t){var i,o,s,l,h,c;if(f.cacheSize&&(o="",n(t.filterRaw,function(n){if(T.isFunction(n))return o="nocache",TAFFY.EXIT}),o===""&&(o=JSON.stringify(T.mergeObj(t,{q:!1,run:!1,sort:!1})))),!t.results||!t.run||t.run&&y.dm()>t.run){if(s=[],f.cacheSize&&p[o])return p[o].i=b++,p[o].results;t.q.length===0&&t.index.length===0?(n(e,function(n){s.push(n)}),i=s):(l=d(t.index),n(l,function(n){(t.q.length===0||r(n,t.q))&&s.push(n)}),i=s)}else i=t.results;return t.order.length>0&&(!t.run||!t.sort)&&(i=v(i,t.order)),i.length&&(t.limit&&t.limit<i.length||t.start)&&(h=[],n(i,function(n,i){if(!t.start||t.start&&i+1>=t.start)if(t.limit){if(c=t.start?i+1-t.start:i,c<t.limit)h.push(n);else if(c>t.limit)return TAFFY.EXIT}else h.push(n)}),i=h),f.cacheSize&&o!=="nocache"&&(k++,setTimeout(function(){var t,n;k>=f.cacheSize*2&&(k=0,t=b-f.cacheSize,n={},u(function(i,r){i.i>=t&&(n[r]=i)}),p=n)},0),p[o]={i:b++,results:i}),i}},s=function(){var r,i;return r=TAFFY.mergeObj(TAFFY.mergeObj(t,{insert:undefined}),{getDBI:function(){return y},getroot:function(n){return s.call(n)},context:function(n){return n&&(i=TAFFY.mergeObj(i,n.hasOwnProperty("results")?TAFFY.mergeObj(n,{run:new Date,sort:new Date}):n)),i},extend:undefined}),i=this&&this.q?this:{limit:!1,start:!1,q:[],filterRaw:[],index:[],order:[],results:!1,run:null,sort:null,settings:f},n(arguments,function(n){a(n)?i.index.push(n):i.q.push(o(n)),i.filterRaw.push(n)}),r},c++,i&&y.insert(i),s.insert=y.insert,s.merge=function(t,i,r){var u={},f=[],e={};return r=r||!1,i=i||"id",n(t,function(n){var t;u[i]=n[i],f.push(n[i]),t=s(u).first(),t?y.update(t.___id,n,r):y.insert(n,r)}),e[i]=f,s(e)},s.TAFFY=!0,s.sort=y.sort,s.settings=function(n){return n&&(f=TAFFY.mergeObj(f,n),n.template&&s().update(n.template)),f},s.store=function(n){var i=!1,t;return localStorage&&(n&&(t=localStorage.getItem("taffy_"+n),t&&t.length>0&&(s.insert(t),i=!0),e.length>0&&setTimeout(function(){localStorage.setItem("taffy_"+f.storageName,JSON.stringify(e))})),s.settings({storageName:n})),s},s},TAFFY=T,T.each=n,T.eachin=u,T.extend=t.extend,TAFFY.EXIT="TAFFYEXIT",TAFFY.mergeObj=function(n,t){var i={};return u(n,function(t,r){i[r]=n[r]}),u(t,function(n,r){i[r]=t[r]}),i},TAFFY.has=function(t,i){var r=!0,f;if(t.TAFFY)return r=t(i),r.length>0?!0:!1;switch(T.typeOf(t)){case"object":if(T.isObject(i))u(i,function(n,u){if(r===!0&&!T.isUndefined(t[u])&&t.hasOwnProperty(u))r=T.has(t[u],i[u]);else return r=!1,TAFFY.EXIT});else if(T.isArray(i))n(i,function(n,u){return r=T.has(t,i[u]),r?TAFFY.EXIT:void 0});else if(T.isString(i))return TAFFY.isUndefined(t[i])?!1:!0;return r;case"array":if(T.isObject(i))n(t,function(n,u){return r=T.has(t[u],i),r===!0?TAFFY.EXIT:void 0});else if(T.isArray(i))n(i,function(u,f){return n(t,function(n,u){return r=T.has(t[u],i[f]),r===!0?TAFFY.EXIT:void 0}),r===!0?TAFFY.EXIT:void 0});else if(T.isString(i)||T.isNumber(i))for(f=0;f<t.length;f++)if(r=T.has(t[f],i),r)return!0;return r;case"string":if(T.isString(i)&&i===t)return!0;break;default:if(T.typeOf(t)===T.typeOf(i)&&t===i)return!0}return!1},TAFFY.hasAll=function(t,i){var u=TAFFY,r;return u.isArray(i)?(r=!0,n(i,function(n){return r=u.has(t,n),r===!1?TAFFY.EXIT:void 0}),r):u.has(t,i)},TAFFY.typeOf=function(n){var t=typeof n;return t==="object"&&(n?typeof n.length!="number"||n.propertyIsEnumerable("length")||(t="array"):t="null"),t},TAFFY.getObjectKeys=function(n){var t=[];return u(n,function(n,i){t.push(i)}),t.sort(),t},TAFFY.isSameArray=function(n,t){return TAFFY.isArray(n)&&TAFFY.isArray(t)&&n.join(",")===t.join(",")?!0:!1},TAFFY.isSameObject=function(n,t){var i=TAFFY,r=!0;return i.isObject(n)&&i.isObject(t)?i.isSameArray(i.getObjectKeys(n),i.getObjectKeys(t))?u(n,function(u,f){if((!i.isObject(n[f])||!i.isObject(t[f])||!i.isSameObject(n[f],t[f]))&&(!i.isArray(n[f])||!i.isArray(t[f])||!i.isSameArray(n[f],t[f]))&&n[f]!==t[f])return r=!1,TAFFY.EXIT}):r=!1:r=!1,r},s=["String","Number","Object","Array","Boolean","Null","Function","Undefined"],y=function(n){return function(t){return TAFFY.typeOf(t)===n.toLowerCase()?!0:!1}},e=0;e<s.length;e++)h=s[e],TAFFY["is"+h]=y(h)})(),typeof exports=="object"&&(exports.taffy=TAFFY)